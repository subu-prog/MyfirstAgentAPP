<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Architect - Interactive Analysis</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --running: #3b82f6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        input[type="password"], 
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .info-box {
            background: #dcfce7;
            border-left: 4px solid var(--success);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        button {
            background-color: var(--primary);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        button:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background-color: #64748b;
            margin-top: 10px;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #475569;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background-color: #16a34a;
        }

        /* Plan Approval Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }

        .plan-step {
            background: #f8fafc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .plan-step h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plan-step-icon {
            font-size: 1.2rem;
        }

        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            border-left: 4px solid var(--warning);
        }

        .feedback-section h4 {
            margin-top: 0;
            color: #92400e;
        }

        .feedback-section textarea {
            margin-top: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
        }

        /* Progress Section */
        .progress-section {
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .overall-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .overall-status h2 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.9);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-status-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .agent-status-card.pending {
            border-color: var(--text-muted);
            opacity: 0.6;
        }

        .agent-status-card.running {
            border-color: var(--running);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }

        .agent-status-card.completed {
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .agent-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .status-badge {
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #f1f5f9;
            color: var(--text-muted);
        }

        .status-badge.running {
            background: #dbeafe;
            color: var(--running);
        }

        .status-badge.completed {
            background: #dcfce7;
            color: var(--success);
        }

        .agent-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .agent-plan {
            margin-top: 15px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .agent-plan h5 {
            margin: 0 0 10px 0;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .loader {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(59, 130, 246, .3);
            border-radius: 50%;
            border-top-color: var(--running);
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .decision-banner {
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .decision-banner.GO {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .decision-banner.NO-GO {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .decision-banner.GO_WITH_CONDITIONS {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .agent-result-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .agent-result-card h3 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.3rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: auto;
        }

        .status-indicator.RED { background: var(--danger); }
        .status-indicator.AMBER { background: var(--warning); }
        .status-indicator.GREEN { background: var(--success); }

        .architect-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: var(--warning);
            border-left-width: 6px;
        }

        .architect-card h3 {
            color: #92400e;
            border-bottom-color: #fbbf24;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ef4444;
        }

        /* Structured JSON Display */
        .json-structured {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .json-property {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .json-property-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .json-property-value {
            color: var(--text-main);
            line-height: 1.6;
        }

        .json-array-item {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 2px solid #cbd5e1;
        }

        .json-object-nested {
            background: white;
            padding: 12px;
            margin-top: 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .severity-badge.RED {
            background: #fee2e2;
            color: #991b1b;
        }

        .severity-badge.AMBER {
            background: #fef3c7;
            color: #92400e;
        }

        .severity-badge.GREEN {
            background: #dcfce7;
            color: #166534;
        }

        .expand-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .expand-toggle:hover {
            background: var(--primary-hover);
        }

        .findings-expanded {
            display: none;
            margin-top: 15px;
        }

        .findings-expanded.show {
            display: block;
        }

        .view-toggle-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .view-toggle {
            flex: 1;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .view-toggle.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .json-view {
            display: none;
        }

        .json-view.active {
            display: block;
        }

        .json-raw {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üèóÔ∏è Deal Architect System</h1>
        <p>Interactive Multi-Agent Analysis with Plan Approval</p>
    </div>

    <div class="card">
        <div class="info-box">
            <strong>‚ú® Interactive Features:</strong><br>
            ‚Ä¢ Review execution plan before running<br>
            ‚Ä¢ Approve or modify agent instructions<br>
            ‚Ä¢ Watch real-time agent progress<br>
            ‚Ä¢ Expandable findings & structured JSON display<br>
            ‚Ä¢ No Assistant setup required - works immediately!
        </div>

        <div class="form-group">
            <label for="apiKey">üîë OpenAI API Key</label>
            <input type="password" id="apiKey" placeholder="sk-...">
        </div>

        <div class="form-group">
            <label for="modelSelect">ü§ñ AI Model</label>
            <select id="modelSelect">
                <option value="gpt-4o">GPT-4o (Recommended - Fast & Smart)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo (High Quality)</option>
                <option value="gpt-4">GPT-4 (Most Capable)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="rfpText">üìÑ RFP Document Text</label>
            <textarea id="rfpText" placeholder="Paste your complete RFP text here...

Include all sections:
- Project overview & objectives
- Technical requirements & specifications
- Contract terms & conditions
- Service Level Agreements (SLAs)
- Pricing & payment terms
- Timeline & milestones
- Acceptance criteria
- Any other relevant information"></textarea>
        </div>

        <button id="analyzeBtn" onclick="showExecutionPlan()">
            <span id="btnText">üìã Review Execution Plan</span>
        </button>
    </div>

    <!-- Plan Approval Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéØ Execution Plan Review</h2>
            </div>

            <p style="color: var(--text-muted); margin-bottom: 20px;">
                Review the analysis plan below. You can approve it as-is or provide modifications.
            </p>

            <div id="planSteps"></div>

            <div class="feedback-section">
                <h4>üí° Modify Plan (Optional)</h4>
                <p style="margin: 0 0 10px 0; font-size: 0.9rem;">
                    Provide any changes or special instructions for the agents:
                </p>
                <textarea id="planFeedback" rows="4" placeholder="Example: 'Focus more on security compliance requirements' or 'Pay special attention to pricing models' or leave blank to proceed as planned..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closePlanModal()">‚ùå Cancel</button>
                <button class="btn-success" onclick="executeWithPlan()">‚úÖ Approve & Execute</button>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
        <div class="overall-status">
            <h2 id="overallStatusText">üìä Initializing...</h2>
            <p id="overallStatusDesc">Preparing agents</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="overallProgress" style="width: 0%"></div>
            </div>
        </div>

        <div class="agents-grid" id="agentsGrid"></div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
        <div id="decisionBanner"></div>
        <div id="resultsArea"></div>
    </div>
</div>

<script>
    // Agent configurations matching your Python code
    const AGENTS = [
        { 
            id: 'legal', 
            name: 'Legal Risk Analyst', 
            icon: '‚öñÔ∏è',
            plan: 'Scan RFP for contract terms, liability clauses, liquidated damages, indemnities, acceptance criteria, termination clauses, IP ownership, and compliance requirements. Flag any RED showstoppers (unlimited liability, LD >10% TCV).',
            systemPrompt: `You are LegalRiskAnalyst, a B2B contract risk specialist. Your only job is to detect and summarize contractual risk, especially Killer Clauses.

Non-negotiable rules:
- Unlimited Liability: ALWAYS classify as RED showstopper. Never accept as-is.
- Liquidated Damages > 10% of TCV: classify as RED showstopper.
- If clause text is ambiguous, treat as at least AMBER and request clarification.

Tasks:
Extract clauses and terms relevant to:
- Liability caps and exclusions (including indirect/consequential)
- Liquidated damages / service credits
- Indemnities (IP, third-party, mutuality)
- Acceptance criteria / deemed acceptance
- Termination for convenience
- Audit rights / security obligations
- IP ownership, escrow, assignment
- Governing law / venue (flag unusual burdens)
- Insurance requirements

Produce structured findings with:
- Clause type
- Severity (RED/AMBER/GREEN)
- Why it matters (commercial impact)
- Recommended redline position

Output MUST be valid JSON:
{
  "agent": "LegalRiskAnalyst",
  "status": "RED|AMBER|GREEN",
  "findings": [
    {
      "clause_type": "string",
      "source_doc": "RFP",
      "excerpt": "exact quote from document",
      "severity": "RED|AMBER|GREEN",
      "why_it_matters": "commercial impact explanation",
      "recommended_redline": "what to negotiate"
    }
  ],
  "showstoppers": ["list of RED items"],
  "conditions_to_proceed": ["actions needed before proceeding"],
  "missing_data": ["what additional info is needed"],
  "notes": ["additional observations"]
}`
        },
        { 
            id: 'winnability', 
            name: 'Winnability Analyst', 
            icon: 'üéØ',
            plan: 'Assess competitive landscape, calculate win probability based on historical patterns, evaluate incumbent presence, analyze timeline constraints, identify key differentiators and strategic fit.',
            systemPrompt: `You are WinnabilityAnalyst. Your job is to assess probability of winning and key drivers based on prior wins/losses and current deal signals.

You MUST ground your analysis in patterns and best practices from B2B sales.

Heuristics:
- If timeline < 10 days and RFP is blind ‚Üí risk up
- If incumbent present ‚Üí risk up
- If requirements name competitor-proprietary tech ‚Üí strong loss risk
- If legal showstoppers (unlimited liability / LD >10%) ‚Üí recommend NO-GO regardless of win odds

Output should include: win_probability (0-100), status (RED/AMBER/GREEN), top_risks, recommended_actions, and evidence.

Output MUST be valid JSON:
{
  "agent": "WinnabilityAnalyst",
  "status": "RED|AMBER|GREEN",
  "win_probability": 0-100,
  "top_risks": ["risk 1", "risk 2", "risk 3"],
  "recommended_actions": ["action 1", "action 2"],
  "competitive_assessment": "brief analysis of competitive landscape",
  "key_strengths": ["our advantage 1", "our advantage 2"],
  "evidence": [
    {
      "source": "historical_pattern",
      "reference": "Similar RFPs with X characteristics",
      "summary": "Pattern observed in past deals"
    }
  ]
}`
        },
        { 
            id: 'finance', 
            name: 'Finance Analyst', 
            icon: 'üí∞',
            plan: 'Calculate or estimate gross margin, evaluate payment terms and cashflow risk, analyze pricing model (T&M vs fixed), identify cost drivers, flag if GM < 20% or missing financial data.',
            systemPrompt: `You are FinanceAnalyst, specialist for B2B deal financial feasibility.

Scope: Pricing, margin, TCV/ACV, cost drivers, payment terms, cashflow risk, and commercial assumptions. Do not opine on legal clause acceptability except where it affects financial exposure (e.g., LDs, credits).

Primary mission: Determine whether the deal meets financial thresholds and highlight risks.

Required checks:
- Compute/estimate Gross Margin (GM%) if revenue and COGS are provided.
- Flag GM% < 20% as RED unless explicitly justified as a loss leader.
- Evaluate payment terms (Net 60/90 = cashflow risk), upfronts, milestones, acceptance gating.
- Identify pricing model risks (T&M vs fixed price; caps; change control).
- Call out missing inputs that prevent calculation (volumes, rates, term, delivery effort, pass-throughs).

Hard constraint: If you cannot calculate GM due to missing inputs, state:
"CANNOT CALCULATE GM: Missing [fields]."
Do not guess numbers.

Output MUST be valid JSON:
{
  "agent": "FinanceAnalyst",
  "status": "RED|AMBER|GREEN",
  "financial_summary": "brief overview",
  "gross_margin_estimate": "X% or CANNOT_CALCULATE",
  "key_risks": ["risk 1", "risk 2"],
  "payment_terms_assessment": "analysis of payment structure",
  "missing_data": ["what's needed for full analysis"],
  "recommendations": ["recommendation 1", "recommendation 2"]
}`
        },
        { 
            id: 'deliverability', 
            name: 'Deliverability Analyst', 
            icon: 'üöö',
            plan: 'Compare requirements against standard capabilities, identify technical gaps, flag "heroics" (custom development, compressed timelines), assess resource needs, evaluate timeline feasibility.',
            systemPrompt: `You are DeliverabilityAnalyst, specialist for technical + operational deliverability supporting DealArchitect.

Scope: Assess whether we can deliver the stated requirements using our Standard Service Catalog and standard delivery model. Identify non-standard "heroics", unrealistic timelines, missing dependencies, and acceptance/testing traps. Do not produce the final Go/No-Go.

Method:
- Extract concrete requirements (SLA/SLO, integrations, security/compliance, data migration, environments, uptime, support hours, acceptance criteria).
- Compare each to standard capabilities. If the requirement is not explicitly standard, mark it as a gap (do not assume capability).
- Flag heroics: custom engineering, compressed delivery, 24x7 support outside standard, bespoke reporting, one-off integrations, unusual audit requirements, on-prem constraints, etc.
- Identify operational risks: resourcing, lead times, third-party dependencies, client responsibilities, ambiguous scope.

Output MUST be valid JSON:
{
  "agent": "DeliverabilityAnalyst",
  "status": "RED|AMBER|GREEN",
  "deliverability_summary": "brief assessment",
  "technical_feasibility": "CAN_DELIVER|NEEDS_HEROICS|CANNOT_DELIVER",
  "key_requirements": ["req 1", "req 2"],
  "gaps": ["gap 1", "gap 2"],
  "heroics_needed": ["heroic 1", "heroic 2"],
  "timeline_assessment": "realistic|aggressive|impossible",
  "resource_estimate": "team size and skills needed",
  "dependencies": ["dependency 1", "dependency 2"],
  "missing_data": ["what info is missing"],
  "questions_for_client": ["question 1", "question 2"]
}`
        }
    ];

    let userFeedback = '';
    let currentRfpText = '';

    function showExecutionPlan() {
        const apiKey = document.getElementById('apiKey').value.trim();
        currentRfpText = document.getElementById('rfpText').value.trim();

        // Validation
        if (!apiKey) {
            alert('‚ö†Ô∏è Please enter your OpenAI API Key.');
            return;
        }

        if (!currentRfpText || currentRfpText.length < 200) {
            alert('‚ö†Ô∏è Please paste substantial RFP content (at least 200 characters).');
            return;
        }

        // Show plan
        let planHTML = '';
        
        planHTML += `
            <div class="plan-step" style="border-left-color: #10b981;">
                <h4><span class="plan-step-icon">üöÄ</span> Phase 1: Parallel Specialist Analysis</h4>
                <p style="margin: 0 0 10px 0;">The following 4 agents will run simultaneously to analyze different aspects of the RFP:</p>
            </div>
        `;

        AGENTS.forEach((agent, index) => {
            planHTML += `
                <div class="plan-step">
                    <h4><span class="plan-step-icon">${agent.icon}</span> ${index + 1}. ${agent.name}</h4>
                    <p style="margin: 0; line-height: 1.6;">${agent.plan}</p>
                </div>
            `;
        });

        planHTML += `
            <div class="plan-step" style="border-left-color: #f59e0b;">
                <h4><span class="plan-step-icon">üèóÔ∏è</span> Phase 2: Deal Architect Synthesis</h4>
                <p style="margin: 0;">After all 4 specialists complete, the Deal Architect will synthesize their findings into a final GO/NO-GO/GO_WITH_CONDITIONS decision using the mandatory decision logic:</p>
                <ul style="margin: 10px 0 0 20px;">
                    <li>If ANY agent returns RED ‚Üí Decision MUST be NO_GO</li>
                    <li>If 2+ agents return AMBER ‚Üí Decision is GO_WITH_CONDITIONS</li>
                    <li>If Legal=RED ‚Üí Decision MUST be NO_GO (non-negotiable)</li>
                    <li>If Winnability < 30% ‚Üí Recommend NO_GO</li>
                </ul>
            </div>
        `;

        document.getElementById('planSteps').innerHTML = planHTML;
        document.getElementById('planModal').classList.add('active');
    }

    function closePlanModal() {
        document.getElementById('planModal').classList.remove('active');
        document.getElementById('planFeedback').value = '';
    }

    function executeWithPlan() {
        userFeedback = document.getElementById('planFeedback').value.trim();
        closePlanModal();
        runFullAnalysis();
    }

    function updateAgentStatus(agentId, status, plan = null) {
        const card = document.getElementById(`agent-${agentId}`);
        if (!card) return;
        
        card.className = `agent-status-card ${status}`;
        const badge = card.querySelector('.status-badge');
        badge.className = `status-badge ${status}`;
        badge.innerHTML = status === 'running' ? '<span class="loader"></span> Running' : status;

        // Show plan when running
        if (status === 'running' && plan) {
            let planDiv = card.querySelector('.agent-plan');
            if (!planDiv) {
                planDiv = document.createElement('div');
                planDiv.className = 'agent-plan';
                card.appendChild(planDiv);
            }
            planDiv.innerHTML = `
                <h5>üîç Current Task:</h5>
                <p style="margin: 0;">${plan}</p>
            `;
        }
    }

    function updateOverallProgress(percent, message) {
        document.getElementById('overallProgress').style.width = `${percent}%`;
        document.getElementById('overallStatusText').textContent = message;
    }

    function initializeProgressUI() {
        const agentsGrid = document.getElementById('agentsGrid');
        agentsGrid.innerHTML = '';

        AGENTS.forEach(agent => {
            agentsGrid.innerHTML += `
                <div id="agent-${agent.id}" class="agent-status-card pending">
                    <div class="agent-icon">${agent.icon}</div>
                    <div class="agent-header">
                        <div class="agent-name">${agent.name}</div>
                        <span class="status-badge pending">Pending</span>
                    </div>
                </div>
            `;
        });

        agentsGrid.innerHTML += `
            <div id="agent-architect" class="agent-status-card pending" style="grid-column: 1 / -1;">
                <div class="agent-icon">üèóÔ∏è</div>
                <div class="agent-header">
                    <div class="agent-name">Deal Architect</div>
                    <span class="status-badge pending">Pending</span>
                </div>
            </div>
        `;
    }

    async function callAgent(agent, rfpText, apiKey, model) {
        updateAgentStatus(agent.id, 'running', agent.plan);
        
        try {
            let message = `Analyze this RFP:\n\n${rfpText}`;
            
            // Add user feedback if provided
            if (userFeedback) {
                message += `\n\n**Special Instructions from User:**\n${userFeedback}`;
            }

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: agent.systemPrompt },
                        { role: 'user', content: message }
                    ],
                    response_format: { type: "json_object" },
                    temperature: 0.7,
                    max_tokens: 2500
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const result = JSON.parse(data.choices[0].message.content);
            
            updateAgentStatus(agent.id, 'completed');
            return result;
        } catch (error) {
            updateAgentStatus(agent.id, 'error');
            throw error;
        }
    }

    async function callDealArchitect(analysesResults, apiKey, model) {
        updateAgentStatus('architect', 'running', 'Synthesizing all specialist findings into final GO/NO-GO decision using mandatory decision logic...');
        
        const architectPrompt = `You are DealArchitect, the master decision-making agent for bid/proposal decisions.

YOUR ROLE:
You receive analysis from 4 specialist agents:
- LegalRiskAnalyst (contract risk, redlines)
- WinnabilityAnalyst (win probability, competitive positioning)
- DeliverabilityAnalyst (technical feasibility, resource availability)
- FinanceAnalyst (margin, profitability, commercial viability)

Your job is to SYNTHESIZE their outputs into ONE executive decision.

DECISION LOGIC (MANDATORY):
1. If ANY agent returns status=RED ‚Üí Decision MUST be NO_GO
2. If 2+ agents return AMBER ‚Üí Decision is GO_WITH_CONDITIONS
3. If Legal=RED ‚Üí Decision MUST be NO_GO (non-negotiable)
4. If Winnability score < 30% ‚Üí Flag as HIGH RISK, recommend NO_GO
5. If Finance margin < company minimum ‚Üí Flag for pricing review

OUTPUT FORMAT (JSON ONLY):
{
  "decision": "GO|NO_GO|GO_WITH_CONDITIONS",
  "confidence": 0-100,
  "primary_rationale": ["reason 1", "reason 2", "reason 3"],
  "key_risks": [
    {
      "risk": "description",
      "severity": "HIGH|MEDIUM|LOW",
      "owner": "Legal|Sales|Security|Delivery|Finance|Other",
      "mitigation": "how to address"
    }
  ],
  "conditions_to_proceed": [
    {
      "condition": "what must happen",
      "owner": "who's responsible",
      "deadline": "before bid | before contract | other"
    }
  ],
  "open_questions": [
    {
      "question": "what needs clarification",
      "why_it_matters": "impact if not resolved",
      "who_to_ask": "client | internal | vendor"
    }
  ],
  "next_steps": ["step 1", "step 2", "step 3"],
  "assumptions": ["assumption 1", "assumption 2"],
  "analyst_summary": {
    "legal": "1 sentence summary",
    "winnability": "1 sentence summary",
    "finance": "1 sentence summary",
    "deliverability": "1 sentence summary"
  }
}

RULES:
- Be decisive. No wishy-washy "it depends" language.
- If Legal says NO, you say NO‚Äîno exceptions.
- Prioritize: Legal blockers > Deliverability gaps > Winnability concerns > Finance margins
- Surface deal-killers immediately in the output
- Keep executive_summary jargon-free (CEO-readable)
- Always output valid JSON, nothing else`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: architectPrompt },
                        { role: 'user', content: `Synthesize these analyses and provide final decision:\n\n${analysesResults}` }
                    ],
                    response_format: { type: "json_object" },
                    temperature: 0.8,
                    max_tokens: 3000
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const result = JSON.parse(data.choices[0].message.content);
            
            updateAgentStatus('architect', 'completed');
            return result;
        } catch (error) {
            updateAgentStatus('architect', 'error');
            throw error;
        }
    }

    async function runFullAnalysis() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const model = document.getElementById('modelSelect').value;
        const rfpText = currentRfpText;

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Running Analysis...';
        
        document.getElementById('progressSection').classList.add('active');
        document.getElementById('resultsSection').classList.remove('active');
        
        initializeProgressUI();
        updateOverallProgress(10, 'üöÄ Initializing...');

        try {
            updateOverallProgress(20, '‚ö° Running 4 agents in parallel...');

            // Phase 1: Run 4 agents in parallel (matching your Python code)
            const agentPromises = AGENTS.map(agent => callAgent(agent, rfpText, apiKey, model));
            const results = await Promise.all(agentPromises);
            
            const resultsMap = {};
            AGENTS.forEach((agent, index) => {
                resultsMap[agent.id] = results[index];
            });

            updateOverallProgress(70, 'üèóÔ∏è Deal Architect synthesizing...');

            // Phase 2: Run Deal Architect
            const analysesText = Object.entries(resultsMap)
                .map(([key, value]) => {
                    const agent = AGENTS.find(a => a.id === key);
                    return `### ${agent.icon} ${agent.name}:\n${JSON.stringify(value, null, 2)}`;
                })
                .join('\n\n---\n\n');

            const finalDecision = await callDealArchitect(analysesText, apiKey, model);

            updateOverallProgress(100, '‚úÖ Complete!');

            setTimeout(() => {
                displayResults(resultsMap, finalDecision);
            }, 1000);

        } catch (error) {
            console.error('Analysis error:', error);
            document.getElementById('agentsGrid').innerHTML += `
                <div class="error-message" style="grid-column: 1 / -1;">
                    <strong>‚ùå Analysis Failed</strong><br>
                    ${error.message}
                </div>
            `;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'üìã Review Execution Plan';
            userFeedback = ''; // Reset feedback
        }
    }

    function toggleFindings(agentId) {
        const expandedDiv = document.getElementById(`findings-expanded-${agentId}`);
        const button = document.getElementById(`expand-btn-${agentId}`);
        
        if (expandedDiv.classList.contains('show')) {
            expandedDiv.classList.remove('show');
            button.textContent = 'Show All Findings';
        } else {
            expandedDiv.classList.add('show');
            button.textContent = 'Show Less';
        }
    }

    function switchView(agentId, view) {
        const structuredView = document.getElementById(`structured-view-${agentId}`);
        const rawView = document.getElementById(`raw-view-${agentId}`);
        const structuredBtn = document.getElementById(`structured-btn-${agentId}`);
        const rawBtn = document.getElementById(`raw-btn-${agentId}`);

        if (view === 'structured') {
            structuredView.classList.add('active');
            rawView.classList.remove('active');
            structuredBtn.classList.add('active');
            rawBtn.classList.remove('active');
        } else {
            rawView.classList.add('active');
            structuredView.classList.remove('active');
            rawBtn.classList.add('active');
            structuredBtn.classList.remove('active');
        }
    }

    function renderStructuredJSON(data) {
        let html = '<div class="json-structured">';
        
        for (const [key, value] of Object.entries(data)) {
            // Skip the 'agent' field as it's redundant in the display
            if (key === 'agent') continue;
            
            html += '<div class="json-property">';
            html += `<div class="json-property-name">${key.replace(/_/g, ' ')}</div>`;
            html += '<div class="json-property-value">';
            
            if (Array.isArray(value)) {
                if (value.length === 0) {
                    html += '<em style="color: var(--text-muted);">None</em>';
                } else {
                    value.forEach((item, index) => {
                        if (typeof item === 'object') {
                            html += '<div class="json-array-item">';
                            html += `<strong style="color: var(--primary);">#${index + 1}</strong><br>`;
                            for (const [k, v] of Object.entries(item)) {
                                if (k === 'severity') {
                                    html += `<strong>${k}:</strong> <span class="severity-badge ${v}">${v}</span><br>`;
                                } else {
                                    html += `<strong>${k}:</strong> ${v}<br>`;
                                }
                            }
                            html += '</div>';
                        } else {
                            html += `<div class="json-array-item">‚Ä¢ ${item}</div>`;
                        }
                    });
                }
            } else if (typeof value === 'object' && value !== null) {
                html += '<div class="json-object-nested">';
                for (const [k, v] of Object.entries(value)) {
                    html += `<strong>${k}:</strong> ${v}<br>`;
                }
                html += '</div>';
            } else {
                if (key === 'status') {
                    html += `<span class="severity-badge ${value}">${value}</span>`;
                } else {
                    html += value || '<em style="color: var(--text-muted);">N/A</em>';
                }
            }
            
            html += '</div>';
            html += '</div>';
        }
        
        html += '</div>';
        return html;
    }

    function displayResults(agentResults, finalDecision) {
        document.getElementById('progressSection').classList.remove('active');
        document.getElementById('resultsSection').classList.add('active');

        const decisionClass = (finalDecision.decision || 'GO').replace(/_/g, '-');
        const decisionEmoji = { 'GO': '‚úÖ', 'NO_GO': '‚ùå', 'GO_WITH_CONDITIONS': '‚ö†Ô∏è' }[finalDecision.decision] || '‚ùì';

        document.getElementById('decisionBanner').innerHTML = `
            <div class="decision-banner ${decisionClass}">
                ${decisionEmoji} FINAL DECISION: ${(finalDecision.decision || 'GO').replace(/_/g, ' ')}
                <div style="font-size: 0.9rem; margin-top: 10px; font-weight: 400;">
                    Confidence: ${finalDecision.confidence || 'N/A'}%
                </div>
            </div>
        `;

        let html = '<div class="results-grid">';

        AGENTS.forEach(agent => {
            const result = agentResults[agent.id];
            const findingsCount = result.findings ? result.findings.length : 0;
            
            html += `
                <div class="agent-result-card">
                    <h3>
                        ${agent.icon} ${agent.name}
                        <span class="status-indicator ${result.status || 'GREEN'}"></span>
                    </h3>

                    <div class="view-toggle-container">
                        <button id="structured-btn-${agent.id}" class="view-toggle active" onclick="switchView('${agent.id}', 'structured')">
                            üìä Structured View
                        </button>
                        <button id="raw-btn-${agent.id}" class="view-toggle" onclick="switchView('${agent.id}', 'raw')">
                            üî§ Raw JSON
                        </button>
                    </div>

                    <div id="structured-view-${agent.id}" class="json-view active">
                        ${renderStructuredJSON(result)}
                        
                        ${findingsCount > 3 ? `
                            <button id="expand-btn-${agent.id}" class="expand-toggle" onclick="toggleFindings('${agent.id}')">
                                Show All ${findingsCount} Findings
                            </button>
                            <div id="findings-expanded-${agent.id}" class="findings-expanded">
                                ${renderStructuredJSON({ all_findings: result.findings })}
                            </div>
                        ` : ''}
                    </div>

                    <div id="raw-view-${agent.id}" class="json-view">
                        <div class="json-raw">${JSON.stringify(result, null, 2)}</div>
                    </div>
                </div>
            `;
        });

        html += `
            <div class="agent-result-card architect-card">
                <h3>üèÜ Deal Architect - Final Decision</h3>

                <div class="view-toggle-container">
                    <button id="structured-btn-architect" class="view-toggle active" onclick="switchView('architect', 'structured')">
                        üìä Structured View
                    </button>
                    <button id="raw-btn-architect" class="view-toggle" onclick="switchView('architect', 'raw')">
                        üî§ Raw JSON
                    </button>
                </div>

                <div id="structured-view-architect" class="json-view active">
                    ${renderStructuredJSON(finalDecision)}
                </div>

                <div id="raw-view-architect" class="json-view">
                    <div class="json-raw">${JSON.stringify(finalDecision, null, 2)}</div>
                </div>
            </div>
        </div>`;

        document.getElementById('resultsArea').innerHTML = html;
    }
</script>

</body>
</html>