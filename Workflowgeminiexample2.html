<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Lab (Real Execution)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Keep existing styles from previous version */
        /* Add these new styles for AI-specific elements */
        .ai-node {
            border-width: 3px;
            border-style: dashed;
        }
        .ai-node::after {
            content: 'AI';
            position: absolute;
            top: -12px;
            right: -12px;
            background: #8b5cf6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .api-status {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin: 10px 0;
        }
        .api-connected {
            background: rgba(16,185,129,0.2);
            color: #10b981;
        }
        .api-disconnected {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }
        .prompt-preview {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            max-height: 150px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Workflow Lab (Real Execution)</h1>
            <p>Visual workflows with actual OpenAI LLM processing</p>
        </header>

        <div class="main-layout">
            <!-- Patterns Panel -->
            <div class="panel">
                <h2>üìã Workflow Patterns</h2>
                <div class="pattern-list">
                    <!-- Keep existing pattern items -->
                </div>
                <div class="api-status" id="api-status">
                    üîå Disconnected (enter API key to enable AI)
                </div>
                <div class="form-group">
                    <label>OpenAI API Key</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
            </div>

            <!-- Canvas Panel -->
            <div class="panel canvas-panel">
                <div class="canvas-toolbar">
                    <button class="toolbar-btn primary" id="run-btn" onclick="runWorkflow()">
                        <span>‚ñ∂Ô∏è</span> Run Workflow
                    </button>
                    <button class="toolbar-btn" onclick="resetWorkflow()">
                        <span>üîÑ</span> Reset
                    </button>
                    <button class="toolbar-btn" onclick="stepWorkflow()">
                        <span>‚è≠Ô∏è</span> Step
                    </button>
                    <div class="speed-control">
                        <label>Speed:</label>
                        <input type="range" id="speed" min="200" max="2000" value="1000">
                    </div>
                </div>

                <div class="workflow-canvas" id="workflow-canvas">
                    <!-- Workflow will be rendered here -->
                </div>
            </div>

            <!-- Info Panel -->
            <div class="panel info-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('learn')">Learn</button>
                    <button class="tab" onclick="switchTab('state')">State</button>
                    <button class="tab" onclick="switchTab('log')">Log</button>
                    <button class="tab" onclick="switchTab('ai')">AI Details</button>
                </div>

                <div class="tab-content active" id="tab-learn">
                    <!-- Keep existing learn content -->
                </div>

                <div class="tab-content" id="tab-state">
                    <!-- Keep existing state content -->
                </div>

                <div class="tab-content" id="tab-log">
                    <!-- Keep existing log content -->
                </div>

                <div class="tab-content" id="tab-ai">
                    <div class="info-card">
                        <h3>ü§ñ AI Execution Details</h3>
                        <div id="ai-details">
                            <p>Select an AI node or run the workflow to see details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Extend patterns with AI-specific node configurations
        const patterns = {
            sequential: {
                // ... (keep existing)
                nodes: [
                    { id: 'start', type: 'start', label: 'Start', icon: 'üöÄ', sublabel: 'Trigger' },
                    { id: 'process1', type: 'process', label: 'User Input', icon: 'üì•', sublabel: 'Query' },
                    { id: 'agent1', type: 'agent', label: 'AI Classify', icon: 'ü§ñ', sublabel: 'LLM', 
                      aiTask: 'classify', 
                      aiPrompt: 'Classify the following user query into one of: "sales", "support", "general". Return only the category. Query: {{state.userInput}}' 
                    },
                    { id: 'process2', type: 'process', label: 'Format', icon: 'üìù', sublabel: 'Transform' },
                    { id: 'end', type: 'end', label: 'Complete', icon: '‚úÖ', sublabel: 'Result' }
                ],
                // ... (keep existing)
            },
            branching: {
                // ... (keep existing)
                nodes: [
                    { id: 'start', type: 'start', label: 'Start', icon: 'üöÄ', sublabel: 'User Query' },
                    { id: 'agent1', type: 'agent', label: 'AI Analyze', icon: 'ü§ñ', sublabel: 'LLM',
                      aiTask: 'analyze',
                      aiPrompt: 'Analyze the sentiment of this query (positive/negative/neutral) and extract key entities. Return as JSON: { "sentiment": "", "entities": [] }. Query: {{state.userInput}}'
                    },
                    { id: 'decision1', type: 'decision', label: 'Sentiment?', icon: '‚ùì', sublabel: 'Condition' },
                    // ... (keep existing)
                ],
                // ... (keep existing)
            },
            // ... (extend other patterns similarly)
        };

        // Global state with AI execution context
        let workflowState = {
            // ... (keep existing)
            aiContext: {
                lastPrompt: '',
                lastResponse: '',
                tokensUsed: 0
            }
        };

        // OpenAI integration
        async function runAI(node, state) {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) throw new Error('No API key provided');

            // Replace template variables in prompt
            const prompt = node.aiPrompt.replace(/{{state\.(\w+)}}/g, (match, key) => state.data[key] || '');
            
            // Update AI context
            workflowState.aiContext = {
                lastPrompt: prompt,
                lastResponse: '',
                tokensUsed: 0
            };
            updateAIDetails();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.2
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                // Update state with AI response
                workflowState.aiContext.lastResponse = data.choices[0].message.content;
                workflowState.aiContext.tokensUsed = data.usage.total_tokens;
                state.data[`ai_${node.id}_output`] = data.choices[0].message.content;

                return data.choices[0].message.content;
            } catch (error) {
                log('error', `AI Execution Failed: ${error.message}`);
                throw error;
            }
        }

        // Modified execution for AI nodes
        async function executeNode(node, speed) {
            if (!node) return;

            workflowState.currentNode = node.id;
            updateStateDisplay();
            
            const el = document.getElementById(`node-${node.id}`);
            if (el) {
                el.classList.add('active');
                log('info', `Executing: ${node.label}`);

                // Special handling for AI nodes
                if (node.type === 'agent') {
                    el.classList.add('ai-node');
                    log('info', 'Running AI processing...');
                    try {
                        const aiResponse = await runAI(node, workflowState);
                        log('success', `AI Output: ${aiResponse.slice(0, 50)}...`);
                    } catch (error) {
                        el.classList.add('error');
                        return;
                    }
                }

                await sleep(speed);
                el.classList.remove('active');
                el.classList.add('completed');
                updateStateDisplay();
            }
        }

        // Update AI details panel
        function updateAIDetails() {
            const aiDetails = document.getElementById('ai-details');
            if (workflowState.aiContext.lastPrompt) {
                aiDetails.innerHTML = `
                    <div class="prompt-preview">
                        <strong>Last Prompt:</strong><br>
                        ${workflowState.aiContext.lastPrompt}
                    </div>
                    <div class="prompt-preview">
                        <strong>Last Response:</strong><br>
                        ${workflowState.aiContext.lastResponse || 'No response yet'}
                    </div>
                    <p>Tokens Used: ${workflowState.aiContext.tokensUsed}</p>
                `;
            } else {
                aiDetails.innerHTML = '<p>No AI execution yet. Run a workflow with AI nodes.</p>';
            }
        }

        // API key status check
        document.getElementById('api-key').addEventListener('input', () => {
            const apiKey = document.getElementById('api-key').value.trim();
            const statusEl = document.getElementById('api-status');
            if (apiKey) {
                statusEl.textContent = 'üîå Connected (AI execution enabled)';
                statusEl.classList.remove('api-disconnected');
                statusEl.classList.add('api-connected');
            } else {
                statusEl.textContent = 'üîå Disconnected (enter API key to enable AI)';
                statusEl.classList.remove('api-connected');
                statusEl.classList.add('api-disconnected');
            }
        });

        // Keep existing functions (renderWorkflow, resetWorkflow, etc.)
        // ... (existing code from previous version)

        // Update tab switching to include AI details
        function switchTab(tabId) {
            // ... (keep existing)
            if (tabId === 'ai') updateAIDetails();
        }
    </script>
</body>
</html>